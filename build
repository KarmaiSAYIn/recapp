#!/bin/sh

export ignored_files=$(cat .buildignore)

in_ignored_files()
{
    for line in ${ignored_files[*]}
    do
        if [ "$line" = "$1" ]
        then
            ignored_files=( ${ignored_files[@]/$file} )
            return 0
        fi
    done
    return 1
}

files_to_compile=$(ls *.cpp)
for file in $files_to_compile
do
    if ( in_ignored_files "$file" )
    then
        files_to_compile=( ${files_to_compile[@]/$file} )
    fi
done

output_file="output"
linux_compile="g++ -g3 -o $output_file ${files_to_compile[*]} -lX11 -lGL -lpthread -lpng -lstdc++fs -std=c++17"
mac_compile="g++ -g3 -arch x86_64 -std=c++17 -mmacosx-version-min=10.15 -Wall -framework OpenGL -framework GLUT -lpng ${files_to_compile[*]} -o $output_file"

run_output=0
count=-1
while [ $count -lt $# ]
do
    case $1 in
        "");;
        -r) # Release compile
            linux_compile=$(echo $linux_compile | sed 's/-g3/-DNDEBUG/')
            mac_compile=$(echo $mac_compile | sed 's/-g3/-DNDEBUG/')
            ;;
        -o) echo build script: Running output...
            run_output=1
            ;;
        *)
            echo Invalid option: $1
            exit 1
            ;;
    esac
    count=$[ $count + 1 ]
    shift 2> /dev/null
done

$(echo $linux_compile | grep "\-g3") && [ "$?" = "0" ] && echo build script: Compiling in debug mode... || echo build script: Compiling in release mode...

echo "build script: Ignoring file(s): ${ignored_files[*]}"
echo

if [ $(echo $OSTYPE | grep "linux") ]
then
    $linux_compile
else
    $mac_compile
fi

[ $run_output -eq 1 ] && output
